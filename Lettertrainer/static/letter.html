<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<link rel="icon" type="image/png" href="assets/img/favicon.ico">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<title>Doot Alphabet Trainer</title>

	<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
	<meta name="viewport" content="width=device-width" />
	<script type="text/javascript" src='assets/js/jquery.js'></script>

	<script type="text/javascript" src='assets/js/d3.js'>

	</script>
	<!-- Bootstrap core CSS     -->
	<link href="assets/css/bootstrap.min.css" rel="stylesheet" />
	<link rel="stylesheet" href="assets/css/bootstrap-switch.css">
	<!-- Animation library for notifications   -->
	<link href="assets/css/animate.min.css" rel="stylesheet" />

	<!--  Light Bootstrap Table core CSS    -->
	<link href="assets/css/light-bootstrap-dashboard.css" rel="stylesheet" />


	<!--  CSS for Demo Purpose, don't include it in your project     -->
	<link href="assets/css/demo.css" rel="stylesheet" />
	<link href="assets/style.css" rel="stylesheet" />

	<!--     Fonts and icons     -->
	<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	<link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300' rel='stylesheet' type='text/css'>
	<link href="assets/css/pe-icon-7-stroke.css" rel="stylesheet" />
	<script type="text/javascript" src='assets/js/bootstrap-switch.js'>

	</script>
	<script type="text/javascript" src='assets/leap-0.6.4.js'></script>

	<script type="text/javascript" src ='assets/letter.js'>

	</script>
	<style media="screen">
				.bar {
			fill: steelblue;
			}

			.bar:hover {
			fill: brown;
			}

			.axis--x path {
			display: none;
			}
	</style>
</head>

<body>

	<div class="wrapper" id='letterTrainer'>
		<div class="">
			<nav class="navbar navbar-default navbar-fixed">
				<div class="container-fluid">
					<div class="navbar-header">
						<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navigation-example-2">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</button>
						<a class="navbar-brand" href="/dashboard">Doot Alphabet Trainer</a>
					</div>
					<ul class='nav navbar-nav navbar-right'>
						<li style="margin-top:3%">
							<a href="#" id='modeDiv'>Training Mode</a>
						</li>
						<li>
							<a href="#">
								<input id='modeSwitch' type="checkbox" name="my-checkbox" checked>
							</a>
						</li>
					</ul>
				</div>
			</nav>


			<div class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-md-6">
							<div class="card">
								<div id="app" class="show-hands" style="width:100%;position:relative;height:300px">
									<div id="scene">
										<div id="cube" class="cube">
											<div class="face tp"></div>
											<div class="face lt"></div>
											<div class="face rt"></div>
											<div class="face ft"></div>
											<div class="face bk"></div>
										</div>
										<div id="finger" class="cube finger">
											<div class="face tp"></div>
											<div class="face lt"></div>
											<div class="face rt"></div>
											<div class="face ft"></div>
											<div class="face bk"></div>
										</div>
										<div id="sphere" class="cube sphere">
											<div class="face tp"></div>
											<div class="face lt"></div>
											<div class="face rt"></div>
											<div class="face ft"></div>
											<div class="face bk"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="card">
								<div class="content">
									<div class="row">
										<div class="col-md-3">
											<h1 id ='testLetter'></h1>
										</div>
										<div class="col-md-9">
											<img id = 'letterImage' class = 'card-bottom-img' src="/static/letters/C.jpg" alt="" style="width:50%;height:230px">
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="card">
								<div class="header">
									<h4 class="title">Score</h4>
								</div>
								<div class="content">
									<h3 id = 'trainScore'>No Scores in Training Mode</h3>
									<div id = 'testScore'>

									</div>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="card">
								<div class="header">
									<h4 class="title">Predicted</h4>
								</div>
								<div class="content">
									<h2 id = 'prediction'>No Prediction</h2>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<footer class="footer">
				<div class="container-fluid">
					<nav class="pull-left">
						<ul>
							<li>
								<a href="#">
																								Doot Letter Trainer
																						</a>
							</li>
						</ul>
					</nav>
					<p class="copyright pull-right">
						&copy; 2017 <a href="#" target="_blank">Team Doot</a>, made with love
					</p>
				</div>
			</footer>
		</div>
	</div>

	<script>
	$(document).ready(function() {
		let quiz = new Quiz(d3.select('#letterTrainer'));
		quiz.nextLetter();
			$('#modeSwitch').bootstrapSwitch({
				onText: 'Train',
				offText: 'Test',
				labelText: 'Mode',
				offColor: 'primary',
				onSwitchChange: (f) => {
					quiz.switchMode();
					return true;
				}
			});
			var ws = new WebSocket('ws://localhost:3000/ws');

			ws.onopen = function(){
				$('#message').text('Open');
			};

			ws.onclose = function(ev){
				$('#message').text('Closed');
			};

			ws.onerror = function(ev){
				$('#message').text('Error');
			};

			ws.onmessage = function(evt){
				if(evt.data != 'undefined') {
					quiz.predict(evt.data)
				}
			};

			function tick(frame) {
				if(isPredicting){
					if(frame.hands){
					 if(frame.hands.length==1){
						 isPredicting = false
						 var strdata = frame.dump().split('Raw JSON:<br/>')[1];
						 var jsondata = JSON.parse(strdata);
						 ws.send(JSON.stringify(jsondata));
						}
					}
				}
			}

			var buffer_frame;

			function moveFinger(Finger, posX, posY, posZ) {
				Finger.style.webkitTransform = "translate3d(" + posX + "px, " + posY + "px, " + posZ + "px)";
			}

			function moveSphere(Sphere, posX, posY, posZ, rotX, rotY, rotZ) {
				Sphere.style.webkitTransform = Sphere.style.mozTransform =
					Sphere.style.transform = "translateX(" + posX + "px) translateY(" + posY + "px) translateZ(" + posZ + "px) rotateX(" + rotX + "deg) rotateY(0deg) rotateZ(0deg)";
			}
			var isPredicting = true;
			setInterval(function() {
				isPredicting = true

			}, 2500)

			var user_agree = false
			var fingers = {};
			var spheres = {};
			var framedata = [];
			var frameLabel = [];
			var framecounts = [0, 0, 0, 0, 0, 0, 0]
			var currentselected = -1;

			Leap.loop(function(frame) {
				//console.log(frame);
				if (frame.valid)
					tick(frame);


				latestFrame = frame;
				var str = "";
				var rotations = frame._rotation;
				for (i in rotations) {
					str += " " + i + " : " + rotations[i] + "<br>";
				}

				var seenFingers = {};
				var handIds = {};
				if (frame.hands === undefined) {
					var handsLength = 0
				} else {
					var handsLength = frame.hands.length;
				}

				for (var handId = 0, handCount = handsLength; handId != handCount; handId++) {
					var hand = frame.hands[handId];
					var posX = (hand.palmPosition[0] * 3);
					var posY = (hand.palmPosition[2] * 3) - 200;
					var posZ = (hand.palmPosition[1] * 3) - 400;
					var rotX = (hand._rotation[2] * 90);
					var rotY = (hand._rotation[1] * 90);
					var rotZ = (hand._rotation[0] * 90);
					var sphere = spheres[hand.id];
					if (!sphere) {
						var sphereDiv = document.getElementById("sphere").cloneNode(true);
						sphereDiv.setAttribute('id', hand.id);
						sphereDiv.style.backgroundColor = '#' + Math.floor(Math.random() * 16777215).toString(16);
						document.getElementById('scene').appendChild(sphereDiv);
						spheres[hand.id] = hand.id;
					} else {
						var sphereDiv = document.getElementById(hand.id);
						if (typeof(sphereDiv) != 'undefined' && sphereDiv != null) {
							moveSphere(sphereDiv, posX, posY, posZ, rotX, rotY, rotZ);
						}
					}
					handIds[hand.id] = true;
				}
				for (handId in spheres) {
					if (!handIds[handId]) {
						var sphereDiv = document.getElementById(spheres[handId]);
						sphereDiv.parentNode.removeChild(sphereDiv);
						delete spheres[handId];
					}
				}

				for (var pointableId = 0, pointableCount = frame.pointables.length; pointableId != pointableCount; pointableId++) {
					var pointable = frame.pointables[pointableId];
					var newFinger = false;
					if (pointable.finger) {
						if (!fingers[pointable.id]) {
							fingers[pointable.id] = [];
							newFinger = true;
						}

						for (var partId = 0, length; partId != 4; partId++) {
							var posX = (pointable.positions[partId][0] * 3);
							var posY = (pointable.positions[partId][2] * 3) - 200;
							var posZ = (pointable.positions[partId][1] * 3) - 400;

							var id = pointable.id + '_' + partId;

							var finger = fingers[id];
							if (newFinger) {
								var fingerDiv = document.getElementById("finger").cloneNode(true);
								fingerDiv.setAttribute('id', id);
								fingerDiv.style.backgroundColor = '#' + Math.floor(pointable.type * 500).toString(16);
								document.getElementById('scene').appendChild(fingerDiv);
								fingers[pointable.id].push(id);
							} else {
								var fingerDiv = document.getElementById(id);
								if (typeof(fingerDiv) != 'undefined' && fingerDiv != null) {
									moveFinger(fingerDiv, posX, posY, posZ);
								}
							}
							seenFingers[pointable.id] = true;
						}

						//var dirX = -(pointable.direction[1]*90);
						//var dirY = -(pointable.direction[2]*90);
						//var dirZ = (pointable.direction[0]*90);
					}
				}
				for (var fingerId in fingers) {
					if (!seenFingers[fingerId]) {
						var ids = fingers[fingerId];
						for (var index in ids) {
							var fingerDiv = document.getElementById(ids[index]);
							fingerDiv.parentNode.removeChild(fingerDiv);
						}
						delete fingers[fingerId];
					}
				}
			});

	});
  </script>

</body>

</html>
